import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart'; 
import 'package:flutter_sound/flutter_sound.dart';
import 'package:permission_handler/permission_handler.dart'; 

void main() => runApp(TextoParaAudioApp());

class TextoParaAudioApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Texto para Áudio',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: TextoParaAudioPage(),
    );
  }
}

class TextoParaAudioPage extends StatefulWidget {
  @override
  _TextoParaAudioPageState createState() => _TextoParaAudioPageState();
}

class _TextoParaAudioPageState extends State<TextoParaAudioPage> {
  late FlutterTts flutterTts;
  final TextEditingController textoController = TextEditingController();
  double velocidade = 1.0;
  List<dynamic> vozes = [];
  String? vozSelecionada;

  late FlutterSoundRecorder recorder;
  bool isRecording = false;

  @override
  void initState() {
    super.initState();
    flutterTts = FlutterTts();
    recorder = FlutterSoundRecorder();
    initRecorder();
    carregarVozes();
  }

  Future<void> carregarVozes() async {
    vozes = await flutterTts.getVoices;
    setState(() {});
  }

  Future<void> initRecorder() async {
    var status = await Permission.microphone.request();
    if (status != PermissionStatus.granted) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Permissão de microfone negada.')));
      return;
    }
    await recorder.openRecorder();
  }

  String limparTexto(String texto) {
    texto = texto.replaceAll('/', '').trim();
    texto = texto.replaceAll(RegExp(r'([\u2190-\u21FF]|[\u2300-\u23FF]|[\u2600-\u26FF]|[\u2700-\u27BF]|[\u2B00-\u2BFF]|[\uD83C-\uDBFF\uDC00-\uDFFF])'), '');

    final numerosPorExtenso = [
      "primeiro", "segundo", "terceiro", "quarto", "quinto",
      "sexto", "sétimo", "oitavo", "nono", "décimo"
    ];

    texto = texto.replaceAllMapped(RegExp(r'^(\d+)\.\s*', multiLine: true), (match) {
      final index = int.parse(match.group(1)!) - 1;
      return index >= 0 && index < numerosPorExtenso.length
          ? '${numerosPorExtenso[index]}: '
          : match.group(0)!;
    });

    return texto;
  }

  Future<void> baixarAudio() async {
    String texto = limparTexto(textoController.text);
    if (texto.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Digite algum texto.')));
      return;
    }

    final path = 'audio_texto.aac';

    await recorder.startRecorder(toFile: path);
    isRecording = true;

    await flutterTts.setLanguage("pt-BR");
    await flutterTts.setSpeechRate(velocidade);
    if (vozSelecionada != null) {
      await flutterTts.setVoice({"name": 'vozSelecionada', "locale": "pt-BR"});
    }

    await flutterTts.speak(texto);

    flutterTts.setCompletionHandler(() async {
      if (isRecording) {
        await recorder.stopRecorder();
        isRecording = false;
        ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Áudio salvo como $path')));
      }
    });
  }

  Future<void> reproduzirAudio() async {
    String texto = limparTexto(textoController.text);
    if (texto.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('Digite algum texto.')));
      return;
    }

    await flutterTts.setLanguage("pt-BR");
    await flutterTts.setSpeechRate(velocidade);
    if (vozSelecionada != null) {
      await flutterTts.setVoice({"name": 'vozSelecionada', "locale": "pt-BR"});
    }

    await flutterTts.speak(texto);

    flutterTts.setCompletionHandler(() {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('A reprodução de áudio foi finalizada.')));
    });
  }

  void pausarAudio() => flutterTts.pause();
  void cancelarAudio() => flutterTts.stop();

  @override
  void dispose() {
    flutterTts.stop();
    recorder.closeRecorder();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold( 
      appBar: AppBar(title: Text('Transforme Texto em Áudio')),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            Expanded(
              child: TextField(
                controller: textoController,
                maxLines: null,
                expands: true,
                decoration: InputDecoration(
                  hintText: 'Digite seu texto aqui...',
                  border: OutlineInputBorder(),
                ),
              ),
            ),
            SizedBox(height: 16),
            Row(
              children: [
                Text('Velocidade da fala:'),
                Expanded(
                  child: Slider(
                    value: velocidade,
                    min: 0.5,
                    max: 2.0,
                    divisions: 15,
                    label: velocidade.toStringAsFixed(1),
                    onChanged: (value) => setState(() => velocidade = value),
                  ),
                ),
              ],
            ),
            DropdownButton<String>(
              value: vozSelecionada,
              hint: Text('Escolha a voz'),
              isExpanded: true,
              items: vozes.map<DropdownMenuItem<String>>((voz) {
                return DropdownMenuItem<String>(
                  value: voz['name'],
                  child: Text('${voz['name']} (${voz['locale']})'),
                );
              }).toList(),
              onChanged: (value) => setState(() => vozSelecionada = value),
            ),
            SizedBox(height: 16),
            Wrap(
              spacing: 10,
              children: [
                ElevatedButton(onPressed: reproduzirAudio, child: Text('▶️ Reproduzir')),
                ElevatedButton(onPressed: pausarAudio, child: Text('⏸️ Pausar')),
                ElevatedButton(onPressed: cancelarAudio, child: Text('⏹️ Cancelar')), 
                ElevatedButton(onPressed: baixarAudio, child: Text('⬇️ Baixar Áudio')),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
